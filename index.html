<!DOCTYPE html>
<html lang="th,en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dolly Tracking Dashboard</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom CSS Variables for easy theming */
        :root {
            --primary: #4f46e5; /* Indigo 600 */
            --primary-dark: #3730a3; /* Indigo 800 */
            --primary-light: #818cf8; /* Indigo 400 */
            --secondary: #0ea5e9; /* Sky 500 */
            --success: #10b981; /* Green 600 */
            --danger: #ef4444; /* Red 500 */
            --warning: #f59e0b; /* Amber 500 */
            --dark: #1e293b; /* Slate 800 */
            --light: #f8fafc; /* Slate 50 */
        }
        
        /* Base body styling with gradients and Inter font */
        body {
            font-family: 'Inter', 'Noto Sans Thai', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #f8fafc 100%); /* Light blue to off-white gradient */
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Thai language specific font override */
        .thai-lang {
            font-family: 'Noto Sans Thai', sans-serif;
        }
        
        /* Card styling with shadow, blur, and subtle border */
        .card {
            background: rgba(255, 255, 255, 0.85); /* Slightly transparent white */
            backdrop-filter: blur(10px); /* Frosted glass effect */
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease; /* Smooth transitions for hover effects */
            border: 1px solid rgba(226, 232, 240, 0.4); /* Light border */
        }
        
        /* Card hover effect */
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15), 0 10px 10px -5px rgba(0, 0, 0, 0.08);
        }
        
        /* KPI card specific styling */
        .kpi-card {
            background: linear-gradient(135deg, #e0e7ff 0%, #dbeafe 100%); /* Light blue gradient */
            border-left: 4px solid var(--primary);
        }
        
        /* Online KPI card specific styling */
        .online-card {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); /* Light green gradient */
            border-left: 4px solid var(--success);
        }
        
        /* Chart container to manage aspect ratio */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            max-height: 350px;
        }
        
        /* Map styling */
        #map {
            height: 100%;
            min-height: 500px;
            border-radius: 16px;
            z-index: 10; /* Ensure map is above other elements when needed */
        }
        
        /* Main tab button styling */
        .main-tab-button {
            flex: 1;
            padding: 1rem;
            font-weight: 600;
            color: #4b5563; /* Gray 700 */
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
            border-bottom: 3px solid transparent;
            background: rgba(226, 232, 240, 0.5); /* Light gray transparent */
        }
        
        /* Main tab button hover effect */
        .main-tab-button:hover {
            background: rgba(224, 231, 255, 0.7); /* Light indigo transparent */
            color: var(--primary-dark);
        }
        
        /* Active main tab button styling */
        .main-tab-button.active {
            background: rgba(255, 255, 255, 0.95); /* Nearly opaque white */
            color: var(--primary);
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05); /* Shadow for active tab */
            border-bottom: 3px solid var(--primary);
            font-weight: 700;
        }

        /* Sub-tab button active styling */
        .tab-button.active {
            background: #e0e7ff; /* bg-indigo-50 */
            color: #4f46e5; /* text-indigo-700 */
        }
        
        /* Pulse animation for online indicators */
        .pulse-online {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); /* Green shadow */
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
        
        /* Primary button styling */
        .btn-primary {
            background: var(--primary);
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        /* Floating action button (FAB) for scroll to top */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        /* FAB hover effect */
        .fab:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.25);
        }
        
        /* Animation for highlighting table rows on update */
        @keyframes highlight-row {
            0% { background-color: rgba(254, 249, 195, 0.8); } /* Light yellow */
            100% { background-color: transparent; }
        }
        
        .highlight {
            animation: highlight-row 2s ease-out;
        }
        
        /* Language toggle styling */
        .lang-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            background: white;
            border-radius: 50px;
            padding: 0.25rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .lang-btn {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .lang-btn.active {
            background: var(--primary);
            color: white;
        }
        
        /* Custom dolly icon for Leaflet map */
        .dolly-icon {
            width: 28px; /* Increased size for better visibility */
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem; /* Increased font size */
            font-weight: bold;
            color: white;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); /* Stronger shadow for distinction */
            transition: background-color 0.3s ease;
            cursor: pointer; /* Indicate interactivity */
        }
        
        .dolly-icon.online {
            background-color: var(--success);
        }
        
        .dolly-icon.offline {
            background-color: var(--danger);
        }
        
        .dolly-icon.unknown {
            background-color: #6b7280; /* Gray 500 */
        }
        
        /* Connection status indicator dots */
        .connection-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connected { background-color: var(--success); }
        .connecting { background-color: var(--warning); }
        .disconnected { background-color: var(--danger); }

        /* Modal styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: white;
            padding: 2.5rem; /* Increased padding */
            border-radius: 16px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 450px; /* Slightly wider */
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-buttons {
            display: flex;
            gap: 1rem; /* Space between buttons */
            justify-content: center;
            margin-top: 1.5rem;
        }
        .modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .modal-buttons .btn-confirm {
            background-color: var(--danger);
            color: white;
        }
        .modal-buttons .btn-confirm:hover {
            background-color: #c23131; /* Darker red */
        }
        .modal-buttons .btn-cancel {
            background-color: #e2e8f0; /* Gray 200 */
            color: #475569; /* Slate 700 */
        }
        .modal-buttons .btn-cancel:hover {
            background-color: #cbd5e1; /* Gray 300 */
        }
        .modal-buttons .btn-alert {
            background-color: var(--primary);
            color: white;
            flex-grow: 1; /* Make it fill space */
        }
        .modal-buttons .btn-alert:hover {
            background-color: var(--primary-dark);
        }

        /* Message Rate animation */
        .message-rate-text {
            display: inline-block;
            transition: transform 0.1s ease-out;
        }

        /* Custom scrollbar for tables */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Notification bar styling */
        #notification-bar {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: auto; /* Adjust width dynamically */
            max-width: 90%;
            min-width: 300px;
            background-color: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 1001; /* Above modal */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        #notification-bar.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        #notification-bar .icon {
            font-size: 1.2rem;
        }
        #notification-bar.success { background-color: var(--success); }
        #notification-bar.error { background-color: var(--danger); }
        #notification-bar.warning { background-color: var(--warning); }
        #notification-bar.info { background-color: var(--primary); }

        /* Login Page Specific Styles */
        .login-bg {
            background: radial-gradient(circle at top left, #a78bfa, #818cf8, #6366f1); /* Gradient purple/blue */
            background-size: 200% 200%;
            animation: gradientAnimation 15s ease infinite;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .password-input-container {
            position: relative;
        }

        .password-toggle-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6b7280; /* Gray 500 */
            font-size: 1.1rem;
            transition: color 0.2s ease;
        }

        .password-toggle-icon:hover {
            color: var(--primary);
        }

        .login-button-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* LLM Summary Modal specific styling */
        #llm-summary-modal .modal-content {
            max-width: 600px;
            text-align: left;
            padding: 3rem;
        }
        #llm-summary-content {
            white-space: pre-wrap; /* Preserves whitespace and line breaks */
            font-size: 0.95rem;
            color: #334155; /* Slate 700 */
            line-height: 1.6;
            max-height: 400px; /* Limit height to prevent modal from growing too large */
            overflow-y: auto; /* Enable scrolling for long content */
            padding-right: 10px; /* Space for scrollbar */
        }
        #llm-summary-content::-webkit-scrollbar {
            width: 8px;
        }
        #llm-summary-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #llm-summary-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #llm-summary-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        #llm-summary-modal .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #64748b; /* Slate 500 */
            cursor: pointer;
            transition: color 0.2s ease;
        }
        #llm-summary-modal .close-button:hover {
            color: #1e293b; /* Slate 800 */
        }

        /* New keyframes for fadeInUp */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Apply to the login card for a smooth entrance */
        .login-card-animated {
            animation: fadeInUp 0.8s ease-out forwards;
        }

        /* Animation for welcome text */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .welcome-text-animated {
            animation: fadeIn 1s ease-out forwards;
            animation-delay: 0.3s; /* Delay for cascade effect */
        }

    </style>
    
    <script>
        // Translation object for Thai/English
        const translations = {
            en: {
                title: "Thai Post National Dolly Tracking Dashboard",
                subtitle: "Real-time tracking and comprehensive insights for the nationwide Thai Post dolly fleet.",
                dashboard: "Dashboard Overview",
                liveData: "Live Map & Data",
                configuration: "Configuration",
                historicalTrends: "Historical Trends", // New tab translation
                networkHealth: "Network Health Overview",
                networkDesc: "Real-time status of your dolly network",
                totalGateways: "TOTAL GATEWAYS",
                onlineGateways: "ONLINE GATEWAYS",
                totalDollies: "TOTAL DOLLIES",
                onlineDollies: "ONLINE DOLLIES",
                gatewayStatus: "Gateway Status",
                dollyStatus: "Dolly Status",
                liveNetwork: "Live Network View",
                liveDesc: "Real-time locations and status updates",
                gateways: "Gateways",
                dollies: "Dollies",
                id: "ID",
                status: "Status",
                gateway: "Gateway",
                rssi: "RSSI",
                systemConfig: "System Configuration",
                configDesc: "Manage your network infrastructure",
                addEdit: "Add / Edit Gateway",
                gatewayId: "Gateway ID",
                gatewayName: "Gateway Name",
                latitude: "Latitude",
                longitude: "Longitude",
                saveGateway: "Save Gateway",
                clear: "Clear",
                configuredGateways: "Configured Gateways",
                actions: "Actions",
                edit: "Edit",
                delete: "Delete",
                online: "Online",
                offline: "Offline",
                user: "User ID",
                mqttStatus: "MQTT Status",
                connecting: "Connecting...",
                connected: "Connected",
                disconnected: "Disconnected",
                resetMap: "Reset Map View",
                dataFlow: "Real-time Data Flow (msg/min)",
                connectedDevices: "Connected Devices",
                distance: "Distance (m)",
                lastSeen: "Last Seen",
                unknown: "Unknown",
                alertFillAllFields: "Please fill in all fields.",
                alertDeleteConfirm: "Are you sure you want to delete gateway",
                modalOk: "OK",
                modalConfirm: "Confirm",
                modalCancel: "Cancel",
                modalAlertTitle: "Notification",
                modalConfirmTitle: "Confirm Action",
                noGatewaysConfigured: "No gateways configured. Please add one using the form above.",
                noGatewaysLive: "No gateways are currently reporting data.",
                noDolliesLive: "No dollies are currently reporting data.",
                searchById: "Search by ID...",
                gatewaySaved: "Gateway successfully saved!",
                gatewayDeleted: "Gateway successfully deleted!",
                mqttConnected: "MQTT Connected!",
                mqttDisconnected: "MQTT Disconnected!",
                mqttError: "MQTT Connection Error!",
                justNow: "just now",
                minutesAgo: "mins ago",
                hoursAgo: "hours ago",
                yesterday: "Yesterday",
                daysAgo: "days ago",
                hourlyMessageRate: "Hourly Message Rate",
                gatewayOnlinePercentage: "Gateway Online Percentage",
                dollyOnlinePercentage: "Dolly Online Percentage",
                login: "Login",
                username: "Username",
                password: "Password",
                loginFailed: "Login failed. Invalid username or password.",
                logout: "Logout",
                userManagement: "User Management",
                forgotPassword: "Forgot Password?",
                createAccount: "Create Account",
                generateSummary: "Generate Network Summary",
                networkSummary: "Network Summary",
                generatingSummary: "Generating summary...",
                welcomeMorning: "Good morning! Welcome!",
                welcomeAfternoon: "Good afternoon! Welcome!",
                welcomeEvening: "Good evening! Welcome!",
                loginSystemIntro: "Welcome to the Thai Post National Dolly Fleet Monitoring System. Your gateway to nationwide logistics insights."
            },
            th: {
                title: "แดชบอร์ดติดตามรถเข็นไปรษณีย์ไทยทั่วประเทศ",
                subtitle: "ระบบติดตามและข้อมูลเชิงลึกแบบเรียลไทม์สำหรับรถเข็นไปรษณีย์ไทยทั่วประเทศ",
                dashboard: "ภาพรวมแดชบอร์ด",
                liveData: "แผนที่และข้อมูลสด",
                configuration: "การกำหนดค่า",
                historicalTrends: "ข้อมูลย้อนหลัง", // Changed from "แนวโน้มย้อนหลัง" to "ข้อมูลย้อนหลัง"
                networkHealth: "สถานะเครือข่าย",
                networkDesc: "ข้อมูลเครือข่ายรถเข็นแบบเรียลไทม์",
                totalGateways: "เกตเวย์ทั้งหมด",
                onlineGateways: "เกตเวย์ออนไลน์",
                totalDollies: "รถเข็นทั้งหมด",
                onlineDollies: "รถเข็นออนไลน์",
                gatewayStatus: "สถานะเกตเวย์",
                dollyStatus: "สถานะรถเข็น",
                liveNetwork: "แสดงเครือข่ายแบบสด",
                liveDesc: "ตำแหน่งและสถานะแบบเรียลไทม์",
                gateways: "เกตเวย์",
                dollies: "รถเข็น",
                id: "รหัส",
                status: "สถานะ",
                gateway: "เกตเวย์",
                rssi: "สัญญาณ",
                systemConfig: "การกำหนดค่าระบบ",
                configDesc: "จัดการโครงสร้างพื้นฐานเครือข่าย",
                addEdit: "เพิ่ม / แก้ไขเกตเวย์",
                gatewayId: "รหัสเกตเวย์",
                gatewayName: "ชื่อเกตเวย์",
                latitude: "ละติจูด",
                longitude: "ลองจิจูด",
                saveGateway: "บันทึกเกตเวย์",
                clear: "ล้าง",
                configuredGateways: "เกตเวย์ที่กำหนดค่า",
                actions: "การดำเนินการ",
                edit: "แก้ไข",
                delete: "ลบ",
                online: "ออนไลน์",
                offline: "ออฟไลน์",
                user: "รหัสผู้ใช้",
                mqttStatus: "สถานะ MQTT",
                connecting: "กำลังเชื่อมต่อ...",
                connected: "เชื่อมต่อแล้ว",
                disconnected: "ตัดการเชื่อมต่อ",
                resetMap: "รีเซ็ตมุมมองแผนที่",
                dataFlow: "การไหลของข้อมูล (ข้อความ/นาที)",
                connectedDevices: "อุปกรณ์ที่เชื่อมต่อ",
                distance: "ระยะทาง (ม.)",
                lastSeen: "อัปเดตล่าสุด",
                unknown: "ไม่ทราบ",
                alertFillAllFields: "กรุณากรอกข้อมูลให้ครบถ้วน",
                alertDeleteConfirm: "คุณแน่ใจหรือไม่ที่จะลบเกตเวย์",
                modalOk: "ตกลง",
                modalConfirm: "ยืนยัน",
                modalCancel: "ยกเลิก",
                modalAlertTitle: "แจ้งเตือน",
                modalConfirmTitle: "ยืนยันการดำเนินการ",
                noGatewaysConfigured: "ยังไม่ได้กำหนดค่าเกตเวย์ โปรดเพิ่มเกตเวย์โดยใช้ฟอร์มด้านบน",
                noGatewaysLive: "ขณะนี้ไม่มีเกตเวย์ใดกำลังรายงานข้อมูล",
                noDolliesLive: "ขณะนี้ไม่มีรถเข็นใดกำลังรายงานข้อมูล",
                searchById: "ค้นหาด้วยรหัส...",
                gatewaySaved: "บันทึกเกตเวย์สำเร็จ!",
                gatewayDeleted: "ลบเกตเวย์สำเร็จ!",
                mqttConnected: "เชื่อมต่อ MQTT แล้ว!",
                mqttDisconnected: "ตัดการเชื่อมต่อ MQTT!",
                mqttError: "ข้อผิดพลาดการเชื่อมต่อ MQTT!",
                justNow: "เมื่อสักครู่",
                minutesAgo: "นาทีที่แล้ว",
                hoursAgo: "ชั่วโมงที่แล้ว",
                yesterday: "เมื่อวานนี้",
                daysAgo: "วันที่แล้ว",
                hourlyMessageRate: "อัตราข้อความรายชั่วโมง",
                gatewayOnlinePercentage: "เปอร์เซ็นต์เกตเวย์ออนไลน์",
                dollyOnlinePercentage: "เปอร์เซ็นต์รถเข็นออนไลน์",
                login: "เข้าสู่ระบบ",
                username: "ชื่อผู้ใช้",
                password: "รหัสผ่าน",
                loginFailed: "เข้าสู่ระบบล้มเหลว ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง",
                logout: "ออกจากระบบ",
                userManagement: "การจัดการผู้ใช้",
                forgotPassword: "ลืมรหัสผ่าน?",
                createAccount: "สร้างบัญชี",
                generateSummary: "สร้างสรุปสถานะเครือข่าย",
                networkSummary: "สรุปสถานะเครือข่าย",
                generatingSummary: "กำลังสร้างสรุป...",
                welcomeMorning: "อรุณสวัสดิ์! ยินดีต้อนรับ!",
                welcomeAfternoon: "สวัสดีตอนบ่าย! ยินดีต้อนรับ!",
                welcomeEvening: "สวัสดีตอนเย็น! ยินดีต้อนรับ!",
                loginSystemIntro: "ยินดีต้อนรับสู่ระบบติดตามรถเข็นไปรษณีย์ไทยทั่วประเทศ ประตูสู่ข้อมูลเชิงลึกด้านโลจิสติกส์ระดับชาติของคุณ"
            }
        };
        
        // Current language state
        let currentLang = 'en';
    </script>
</head>
<body class="min-h-screen">
    <!-- Language Toggle -->
    <div class="lang-toggle flex">
        <div class="lang-btn active" id="lang-en">EN</div>
        <div class="lang-btn" id="lang-th">ไทย</div>
    </div>

    <!-- Notification Bar -->
    <div id="notification-bar" class="hidden">
        <span class="icon"></span>
        <span id="notification-message"></span>
    </div>

    <!-- Login Container -->
    <div id="login-container" class="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-100 login-bg">
        <div class="card p-8 w-full max-w-md login-card login-card-animated">
            <div class="text-center mb-6">
                <p id="welcome-message" class="text-lg text-gray-700 font-semibold mb-2 welcome-text-animated"></p>
                <p class="text-sm text-gray-500 mb-4" data-i18n="loginSystemIntro">Welcome to the Thai Post National Dolly Fleet Monitoring System. Your gateway to nationwide logistics insights.</p>
                <i class="fas fa-box-open text-6xl text-indigo-600 mb-4 opacity-80"></i>
                <h2 class="text-3xl font-bold text-gray-800" data-i18n="login">Login</h2>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="username">Username</label>
                    <input type="text" id="login-username" name="username" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200" autocomplete="username">
                </div>
                <div class="password-input-container">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="password">Password</label>
                    <input type="password" id="login-password" name="password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200" autocomplete="current-password">
                    <span class="password-toggle-icon" id="toggle-password">
                        <i class="fas fa-eye"></i>
                    </span>
                </div>
                <div class="flex items-center justify-between text-sm">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-gray-900">
                            Remember me
                        </label>
                    </div>
                    <a href="#" class="font-medium text-indigo-600 hover:text-indigo-500 hover:underline" data-i18n="forgotPassword">Forgot Password?</a>
                </div>

                <div id="login-error-message" class="text-red-600 text-sm text-center hidden"></div>

                <button type="submit" id="login-button" class="btn-primary w-full py-3 px-6 rounded-lg font-medium flex items-center justify-center gap-2 transform transition duration-200 hover:scale-[1.02]">
                    <span class="login-button-content">
                        <span id="login-button-text" data-i18n="login">Login</span>
                        <div id="login-spinner" class="spinner hidden"></div>
                    </span>
                </button>
            </form>
            <p class="text-sm text-gray-500 text-center mt-6">Admin: admin/admin | User: user/user</p>
            <div class="text-center mt-4">
                <a href="#" class="font-medium text-indigo-600 hover:text-indigo-500 hover:underline text-sm" data-i18n="createAccount">Create Account</a>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="main-app-container" class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl hidden">
        <!-- Header -->
        <header class="mb-8 text-center card p-6 relative overflow-hidden">
            <!-- Decorative elements for visual appeal -->
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
            <div class="absolute -top-20 -right-20 w-40 h-40 rounded-full bg-indigo-100 opacity-50"></div>
            <div class="absolute -bottom-20 -left-20 w-40 h-40 rounded-full bg-blue-100 opacity-50"></div>
            
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2" data-i18n="title">Thai Post National Dolly Tracking Dashboard</h1>
            <p class="text-lg text-gray-600 mb-4" data-i18n="subtitle">Real-time tracking and comprehensive insights for the nationwide Thai Post dolly fleet.</p>
            
            <div class="flex flex-wrap justify-center items-center text-sm font-light text-gray-500 gap-4 mt-4">
                <div id="user-info-display"><span data-i18n="user">User ID</span>: <span class="font-semibold text-gray-700" id="current-user-info">Guest</span></div>
                <div id="mqtt-status-container">
                    <span class="connection-indicator connecting"></span>
                    <span data-i18n="mqttStatus">MQTT Status</span>: 
                    <span class="font-bold" id="mqtt-status-text" data-i18n="connecting">Connecting...</span>
                </div>
                <div id="current-time" class="font-medium">00:00:00 +07:00</div>
                <button id="logout-btn" class="ml-4 py-1 px-3 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-200" data-i18n="logout">Logout</button>
            </div>
        </header>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card p-4 flex items-center transform transition duration-300 hover:scale-105">
                <div class="bg-indigo-100 p-3 rounded-full mr-4">
                    <i class="fas fa-network-wired text-indigo-600 text-xl"></i>
                </div>
                <div>
                    <div class="text-sm text-gray-500" data-i18n="connectedDevices">Connected Devices</div>
                    <div class="text-2xl font-bold"><span id="total-devices">0</span> <span class="text-sm font-normal text-green-600"><i class="fas fa-arrow-up mr-1"></i><span id="device-change">0</span></span></div>
                </div>
            </div>
            
            <div class="card p-4 flex items-center transform transition duration-300 hover:scale-105">
                <div class="bg-green-100 p-3 rounded-full mr-4">
                    <i class="fas fa-signal text-green-600 text-xl"></i>
                </div>
                <div>
                    <div class="text-sm text-gray-500" data-i18n="dataFlow">Real-time Data Flow (msg/min)</div>
                    <div class="text-2xl font-bold"><span id="messages-received" class="message-rate-text">0</span></div>
                </div>
            </div>
            
            <div class="card p-4 flex items-center transform transition duration-300 hover:scale-105">
                <div class="bg-blue-100 p-3 rounded-full mr-4">
                    <i class="fas fa-satellite-dish text-blue-600 text-xl"></i>
                </div>
                <div>
                    <div class="text-sm text-gray-500">Network Uptime</div>
                    <div class="text-2xl font-bold"><span id="uptime">100</span>%</div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <nav class="flex border-b border-gray-200 mb-8 rounded-t-lg overflow-hidden">
            <button id="tab-dashboard" class="main-tab-button active" data-tab="dashboard" data-i18n="dashboard">Dashboard Overview</button>
            <button id="tab-live-data" class="main-tab-button" data-tab="live-data" data-i18n="liveData">Live Map & Data</button>
            <button id="tab-configuration" class="main-tab-button" data-tab="configuration" data-i18n="configuration">Configuration</button>
            <button id="tab-historical-trends" class="main-tab-button" data-tab="historical-trends" data-i18n="historicalTrends">Historical Trends</button>
            <button id="tab-user-management" class="main-tab-button hidden" data-tab="user-management" data-i18n="userManagement">User Management</button>
        </nav>

        <!-- Tab Content Areas -->
        <div id="dashboard" class="tab-content">
            <section class="mb-12">
                <div class="mb-8 pb-4 flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2" data-i18n="networkHealth">Network Health Overview</h2>
                        <p class="text-gray-500 max-w-3xl" data-i18n="networkDesc">Real-time status of your dolly network</p>
                    </div>
                    <button id="generate-summary-btn" class="btn-primary py-3 px-6 rounded-lg font-medium flex items-center justify-center gap-2 transform transition duration-200 hover:scale-[1.02]">
                        <span id="summary-button-text" data-i18n="generateSummary">✨ Generate Network Summary</span>
                        <div id="summary-spinner" class="spinner hidden w-5 h-5 border-2"></div>
                    </button>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="card kpi-card p-6 flex items-center justify-between transform transition duration-300 hover:scale-105">
                        <div>
                            <h3 class="text-sm font-semibold text-gray-500 mb-2" data-i18n="totalGateways">TOTAL GATEWAYS</h3>
                            <p id="total-gateways" class="text-3xl font-bold text-indigo-600">0</p>
                        </div>
                        <i class="fas fa-hdd text-indigo-300 text-4xl opacity-50"></i>
                    </div>
                    <div class="card online-card p-6 flex items-center justify-between transform transition duration-300 hover:scale-105">
                        <div>
                            <h3 class="text-sm font-semibold text-gray-500 mb-2" data-i18n="onlineGateways">ONLINE GATEWAYS</h3>
                            <p id="online-gateways" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <i class="fas fa-wifi text-green-300 text-4xl opacity-50"></i>
                    </div>
                    <div class="card kpi-card p-6 flex items-center justify-between transform transition duration-300 hover:scale-105">
                        <div>
                            <h3 class="text-sm font-semibold text-gray-500 mb-2" data-i18n="totalDollies">TOTAL DOLLIES</h3>
                            <p id="total-dollies" class="text-3xl font-bold text-indigo-600">0</p>
                        </div>
                        <i class="fas fa-truck-ramp-box text-indigo-300 text-4xl opacity-50"></i>
                    </div>
                    <div class="card online-card p-6 flex items-center justify-between transform transition duration-300 hover:scale-105">
                        <div>
                            <h3 class="text-sm font-semibold text-gray-500 mb-2" data-i18n="onlineDollies">ONLINE DOLLIES</h3>
                            <p id="online-dollies" class="text-3xl font-bold text-green-600">0</p>
                        </div>
                        <i class="fas fa-boxes-stacked text-green-300 text-4xl opacity-50"></i>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-bold text-center mb-4" data-i18n="gatewayStatus">Gateway Status</h3>
                        <div class="chart-container">
                            <canvas id="gatewaysChart"></canvas>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-bold text-center mb-4" data-i18n="dollyStatus">Dolly Status</h3>
                        <div class="chart-container">
                            <canvas id="dolliesChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="live-data" class="tab-content hidden">
            <section class="mb-12">
                <div class="mb-8 pb-4">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2" data-i18n="liveNetwork">Live Network View</h2>
                    <p class="text-gray-500 max-w-3xl" data-i18n="liveDesc">Real-time locations and status updates</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <!-- Map -->
                    <div class="lg:col-span-3 card p-4 relative">
                        <div id="map"></div>
                        <button id="reset-map" class="absolute top-4 right-4 z-20 bg-white rounded-full p-2 shadow-md hover:bg-gray-50 transition duration-200" title="Reset Map View">
                            <i class="fas fa-sync-alt text-indigo-600"></i>
                        </button>
                    </div>
                    
                    <!-- Data Tables -->
                    <div class="lg:col-span-2 card p-6">
                        <div class="mb-4">
                            <div class="flex border-b border-gray-200">
                                <button id="show-gateways-btn" class="tab-button active flex-1 py-2 px-4 font-medium text-center rounded-t-lg bg-indigo-50 text-indigo-700" data-i18n="gateways">Gateways</button>
                                <button id="show-dollies-btn" class="tab-button flex-1 py-2 px-4 font-medium text-center rounded-t-lg hover:bg-indigo-50" data-i18n="dollies">Dollies</button>
                            </div>
                        </div>

                        <!-- Gateways Table -->
                        <div id="gateways-table-container">
                            <div class="p-2 bg-gray-50 rounded-t-lg">
                                <input type="text" id="search-gateways" placeholder="Search by ID..." data-i18n-placeholder="searchById" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                            </div>
                            <div class="overflow-x-auto max-h-[480px] custom-scroll">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="id">ID</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="status">Status</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="lastSeen">Last Seen</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gateways-tbody" class="bg-white divide-y divide-gray-200">
                                        <!-- Will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Dollies Table -->
                        <div id="dollies-table-container" class="hidden">
                             <div class="p-2 bg-gray-50 rounded-t-lg">
                                <input type="text" id="search-dollies" placeholder="Search by ID..." data-i18n-placeholder="searchById" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                            </div>
                            <div class="overflow-x-auto max-h-[480px] custom-scroll">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="id">ID</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="status">Status</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="gateway">Gateway</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="rssi">RSSI</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="distance">Distance (m)</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-i18n="lastSeen">Last Seen</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dollies-tbody" class="bg-white divide-y divide-gray-200">
                                        <!-- Will be populated by MQTT data -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="configuration" class="tab-content hidden">
            <section>
                <div class="mb-8 pb-4">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2" data-i18n="systemConfig">System Configuration</h2>
                    <p class="text-gray-500 max-w-3xl" data-i18n="configDesc">Manage your network infrastructure</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Add/Edit Form -->
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4" data-i18n="addEdit">Add / Edit Gateway</h3>
                        <form id="gateway-form" class="space-y-4">
                            <input type="hidden" id="edit-id">
                            <div>
                                <label for="gatewayId" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="gatewayId">Gateway ID</label>
                                <input type="text" id="gatewayId" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                            </div>
                            <div>
                                <label for="gatewayName" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="gatewayName">Gateway Name</label>
                                <input type="text" id="gatewayName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="latitude" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="latitude">Latitude</label>
                                    <input type="number" step="any" id="latitude" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                                </div>
                                <div>
                                    <label for="longitude" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="longitude">Longitude</label>
                                    <input type="number" step="any" id="longitude" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4 mt-6">
                                <button type="submit" class="btn-primary py-3 px-6 rounded-lg font-medium flex-1 flex items-center justify-center gap-2 transform transition duration-200 hover:scale-[1.02]" data-i18n="saveGateway">
                                    <i class="fas fa-save"></i> Save Gateway
                                </button>
                                <button type="button" id="clear-form-btn" class="py-3 px-6 rounded-lg font-medium border border-gray-300 hover:bg-gray-50 flex-1 flex items-center justify-center gap-2 transform transition duration-200 hover:scale-[1.02]" data-i18n="clear">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Configured Gateways Table -->
                    <div class="card p-6">
                        <h3 class="text-xl font-bold mb-4" data-i18n="configuredGateways">Configured Gateways</h3>
                        <div class="overflow-y-auto max-h-[350px] custom-scroll">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-i18n="id">ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-i18n="gatewayName">Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase" data-i18n="actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="config-gateways-tbody" class="bg-white divide-y divide-gray-200">
                                    <!-- Will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="historical-trends" class="tab-content hidden">
            <section class="mb-12">
                <div class="mb-8 pb-4">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2" data-i18n="historicalTrends">Historical Trends</h2>
                    <p class="text-gray-500 max-w-3xl">View historical data and trends for network performance.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card p-6">
                        <h3 class="text-xl font-bold text-center mb-4" data-i18n="hourlyMessageRate">Hourly Message Rate</h3>
                        <div class="chart-container">
                            <canvas id="hourlyMessageRateChart"></canvas>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-bold text-center mb-4" data-i18n="gatewayOnlinePercentage">Gateway Online Percentage</h3>
                        <div class="chart-container">
                            <canvas id="gatewayOnlinePercentageChart"></canvas>
                        </div>
                    </div>
                    <!-- New Dolly Online Percentage Chart -->
                    <div class="card p-6">
                        <h3 class="text-xl font-bold text-center mb-4" data-i18n="dollyOnlinePercentage">Dolly Online Percentage</h3>
                        <div class="chart-container">
                            <canvas id="dollyOnlinePercentageChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="user-management" class="tab-content hidden">
            <section class="mb-12">
                <div class="mb-8 pb-4">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2" data-i18n="userManagement">User Management</h2>
                    <p class="text-gray-500 max-w-3xl">Manage user accounts and roles for the dashboard.</p>
                </div>
                <div class="card p-6">
                    <h3 class="text-xl font-bold mb-4">User Accounts</h3>
                    <div class="overflow-y-auto max-h-[350px] custom-scroll">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Users will be populated here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>
    
    <!-- Floating Action Button -->
    <div class="fab" id="scroll-top" title="Scroll to top">
        <i class="fas fa-arrow-up text-xl"></i>
    </div>

    <!-- Custom Modal for Alerts and Confirms -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div id="modal-buttons" class="modal-buttons">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <!-- LLM Summary Modal -->
    <div id="llm-summary-modal" class="modal">
        <div class="modal-content relative">
            <button class="close-button" onclick="document.getElementById('llm-summary-modal').classList.remove('show');">&times;</button>
            <h3 id="llm-summary-title" class="text-xl font-bold mb-4 text-gray-800 text-center" data-i18n="networkSummary">Network Summary</h3>
            <div id="llm-summary-loading" class="flex justify-center items-center py-8 hidden">
                <div class="spinner w-8 h-8 border-4 border-indigo-200 border-t-indigo-600"></div>
                <p class="ml-4 text-gray-600" data-i18n="generatingSummary">Generating summary...</p>
            </div>
            <div id="llm-summary-content" class="text-gray-700">
                <!-- Summary will be injected here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA STORE ---
            // Stores configured gateways, acting as the 'source of truth' for known gateway locations
            let configuredGateways = {
                "gateway1": { id: "gateway1", name: "ที่ทำการไปรษณีย์หลักสี่", lat: 13.8897, lon: 100.5817 },
                "gateway2": { id: "gateway2", name: "ไปรษณีย์ไทย สาขาปทุมธานี", lat: 14.0223, lon: 100.5300 },
                "gateway3": { id: "gateway3", name: "ไปรษณีย์อยุธยา", lat: 14.3650605, lon: 100.5378306 }
            };

            // liveData will store current status received via MQTT, including dynamic dollies
            // Gateways in liveData are initially populated from configuredGateways to ensure all configured are present
            let liveData = {
                gateways: {},
                dollies: {}
            };
            // Initialize liveData.gateways with configured ones and an 'UNKNOWN' status
            Object.values(configuredGateways).forEach(gw => {
                liveData.gateways[gw.id] = { ...gw, status: 'UNKNOWN', lastSeen: 0 };
            });
            
            let messageCount = 0; // Total messages received since page load
            let prevTotalDevices = 0; // For tracking device count changes in KPIs
            let startTime = Date.now(); // For calculating uptime (simplified)
            let lastMinuteMessageCount = 0; // To track messages per minute for KPI
            let messageRateInterval; // Interval for updating message rate KPI

            // --- AUTHENTICATION & ROLES (MOCK) ---
            let currentUser = null; // Stores { username: '...', role: '...' } or null
            const mockUsers = {
                'admin': { password: 'admin', role: 'admin' },
                'user': { password: 'user', role: 'user' }
            };

            // --- CHART & MAP INSTANCES ---
            let gatewaysChartInstance = null;
            let dolliesChartInstance = null;
            let map = null;
            let mapInitialized = false; // Flag to track if map has been initialized
            const gatewayMapMarkers = {}; // Stores Leaflet markers for gateways
            const dollyMapMarkers = {}; // Stores Leaflet markers for dollies
            let socket = null; // WebSocket connection instance

            // Historical Chart Instances
            let hourlyMessageRateChartInstance = null;
            let gatewayOnlinePercentageChartInstance = null;
            let dollyOnlinePercentageChartInstance = null; // New chart instance

            // --- DOM ELEMENTS ---
            const loginContainer = document.getElementById('login-container');
            const mainAppContainer = document.getElementById('main-app-container');
            const loginForm = document.getElementById('login-form');
            const loginUsernameInput = document.getElementById('login-username');
            const loginPasswordInput = document.getElementById('login-password');
            const loginButton = document.getElementById('login-button');
            const loginButtonText = document.getElementById('login-button-text');
            const loginSpinner = document.getElementById('login-spinner');
            const loginErrorMessage = document.getElementById('login-error-message');
            const togglePassword = document.getElementById('toggle-password');
            const welcomeMessageEl = document.getElementById('welcome-message');


            const currentUserInfoEl = document.getElementById('current-user-info');
            const logoutBtn = document.getElementById('logout-btn');

            const gatewaysTbody = document.getElementById('gateways-tbody');
            const dolliesTbody = document.getElementById('dollies-tbody');
            const configGatewaysTbody = document.getElementById('config-gateways-tbody');
            const gatewayForm = document.getElementById('gateway-form');
            const mqttStatusText = document.getElementById('mqtt-status-text');
            const mqttStatusIndicator = document.querySelector('.connection-indicator');
            const currentTimeEl = document.getElementById('current-time');
            const scrollTopBtn = document.getElementById('scroll-top');
            const resetMapBtn = document.getElementById('reset-map');
            const totalDevicesEl = document.getElementById('total-devices');
            const deviceChangeEl = document.getElementById('device-change');
            const messagesReceivedEl = document.getElementById('messages-received');
            const uptimeEl = document.getElementById('uptime');

            // Custom Modal Elements
            const customModal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');

            // Notification Bar Elements
            const notificationBar = document.getElementById('notification-bar');
            const notificationMessage = document.getElementById('notification-message');
            const notificationIcon = notificationBar.querySelector('.icon');

            // Search inputs
            const searchGatewaysInput = document.getElementById('search-gateways');
            const searchDolliesInput = document.getElementById('search-dollies');
            
            // User Management Table
            const userListTbody = document.getElementById('user-list-tbody');

            // LLM Summary Elements
            const generateSummaryBtn = document.getElementById('generate-summary-btn');
            const summaryButtonText = document.getElementById('summary-button-text');
            const summarySpinner = document.getElementById('summary-spinner');
            const llmSummaryModal = document.getElementById('llm-summary-modal');
            const llmSummaryTitle = document.getElementById('llm-summary-title');
            const llmSummaryContent = document.getElementById('llm-summary-content');
            const llmSummaryLoading = document.getElementById('llm-summary-loading');


            // --- AUTHENTICATION FUNCTIONS ---
            /**
             * Shows the login screen and hides the main application.
             */
            function showLoginScreen() {
                mainAppContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                loginForm.reset(); // Clear form fields
                loginUsernameInput.focus(); // Focus username field for convenience
                updateMqttStatusDisplay(); // Ensure MQTT status reflects disconnected state on logout
                loginErrorMessage.classList.add('hidden'); // Hide any previous error messages
                updateWelcomeMessage(); // Update welcome message on login screen
            }

            /**
             * Shows the main application and hides the login screen.
             */
            function showMainApp() {
                loginContainer.classList.add('hidden');
                mainAppContainer.classList.remove('hidden');
                updateUIBasedOnRole();
                renderAll(); // Re-render all dashboard elements after login
                connectToMQTT(); // Establish MQTT connection after successful login
            }

            /**
             * Handles the login attempt.
             * @param {Event} e - The form submission event.
             */
            async function handleLogin(e) {
                e.preventDefault();
                loginErrorMessage.classList.add('hidden'); // Hide previous error
                loginButton.disabled = true; // Disable button
                loginSpinner.classList.remove('hidden'); // Show spinner
                loginButtonText.classList.add('hidden'); // Hide text

                const username = loginUsernameInput.value.trim();
                const password = loginPasswordInput.value.trim();

                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1000));

                if (mockUsers[username] && mockUsers[username].password === password) {
                    currentUser = { username: username, role: mockUsers[username].role };
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); // Store mock user in session
                    showMainApp();
                } else {
                    loginErrorMessage.textContent = translations[currentLang].loginFailed;
                    loginErrorMessage.classList.remove('hidden');
                }

                loginButton.disabled = false; // Re-enable button
                loginSpinner.classList.add('hidden'); // Hide spinner
                loginButtonText.classList.remove('hidden'); // Show text
            }

            /**
             * Handles the logout action.
             */
            function handleLogout() {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                disconnectFromMQTT(); // Disconnect MQTT on logout
                showLoginScreen();
            }

            /**
             * Updates UI elements based on the current user's role.
             */
            function updateUIBasedOnRole() {
                const isAdmin = currentUser && currentUser.role === 'admin';

                // Update user info display
                currentUserInfoEl.textContent = currentUser ? `${currentUser.username} (${currentUser.role})` : 'Guest';
                
                // Hide/show Configuration tab
                const configTab = document.getElementById('tab-configuration');
                if (isAdmin) {
                    configTab.classList.remove('hidden');
                } else {
                    configTab.classList.add('hidden');
                    // If user is not admin and is currently on config tab, switch to dashboard
                    if (document.getElementById('configuration').classList.contains('active')) {
                        document.getElementById('tab-dashboard').click(); 
                    }
                }

                // Hide/show User Management tab
                const userManagementTab = document.getElementById('tab-user-management');
                if (isAdmin) {
                    userManagementTab.classList.remove('hidden');
                } else {
                    userManagementTab.classList.add('hidden');
                    // If user is not admin and is currently on user management tab, switch to dashboard
                     if (document.getElementById('user-management').classList.contains('active')) {
                        document.getElementById('tab-dashboard').click(); 
                    }
                }

                // Update visibility of logout button
                if (currentUser) {
                    logoutBtn.classList.remove('hidden');
                } else {
                    logoutBtn.classList.add('hidden');
                }
            }

            /**
             * Updates the welcome message on the login screen based on the time of day.
             */
            function updateWelcomeMessage() {
                const hour = new Date().getHours();
                let welcomeKey;
                if (hour < 12) {
                    welcomeKey = 'welcomeMorning';
                } else if (hour < 18) {
                    welcomeKey = 'welcomeAfternoon';
                } else {
                    welcomeKey = 'welcomeEvening';
                }
                welcomeMessageEl.textContent = translations[currentLang][welcomeKey];
            }


            // --- CUSTOM MODAL FUNCTIONS (Replaces native alert/confirm) ---
            /**
             * Displays a custom alert modal.
             * @param {string} message - The message to display.
             * @param {string} [title='Alert'] - The title of the modal.
             */
            function showAlert(message, title = translations[currentLang].modalAlertTitle || "Alert") {
                return new Promise(resolve => {
                    modalTitle.textContent = title;
                    modalMessage.textContent = message;
                    modalButtons.innerHTML = `
                        <button class="btn-alert btn-primary" data-action="ok">${translations[currentLang].modalOk}</button>
                    `;
                    
                    customModal.classList.add('show');

                    modalButtons.querySelector('[data-action="ok"]').onclick = () => {
                        customModal.classList.remove('show');
                        resolve(true); // Always resolves true for an alert
                    };
                });
            }

            /**
             * Displays a custom confirmation modal.
             * @param {string} message - The confirmation message.
             * @param {string} [title='Confirm'] - The title of the modal.
             * @returns {Promise<boolean>} Resolves true if confirmed, false if cancelled.
             */
            function showConfirm(message, title = translations[currentLang].modalConfirmTitle || "Confirm") {
                return new Promise(resolve => {
                    modalTitle.textContent = title;
                    modalMessage.textContent = message;
                    modalButtons.innerHTML = `
                        <button class="btn-confirm" data-action="confirm">${translations[currentLang].modalConfirm}</button>
                        <button class="btn-cancel" data-action="cancel">${translations[currentLang].modalCancel}</button>
                    `;
                    
                    customModal.classList.add('show');

                    modalButtons.querySelector('[data-action="confirm"]').onclick = () => {
                        customModal.classList.remove('show');
                        resolve(true);
                    };
                    modalButtons.querySelector('[data-action="cancel"]').onclick = () => {
                        customModal.classList.remove('show');
                        resolve(false);
                    };
                });
            }

            // --- NOTIFICATION SYSTEM ---
            /**
             * Displays a temporary notification at the top of the screen.
             * @param {string} message - The message to display.
             * @param {string} type - 'success', 'error', 'warning', or 'info'.
             * @param {number} duration - How long the notification should be visible in ms.
             */
            function showNotification(message, type = 'info', duration = 3000) {
                notificationMessage.textContent = message;
                notificationBar.className = ``; // Reset classes
                notificationBar.classList.add('show', type);

                let iconClass = '';
                switch(type) {
                    case 'success': iconClass = 'fas fa-check-circle'; break;
                    case 'error': iconClass = 'fas fa-times-circle'; break;
                    case 'warning': iconClass = 'fas fa-exclamation-triangle'; break;
                    case 'info': iconClass = 'fas fa-info-circle'; break;
                }
                notificationIcon.className = `icon ${iconClass}`;

                clearTimeout(notificationBar.timer); // Clear any existing timer
                notificationBar.timer = setTimeout(() => {
                    notificationBar.classList.remove('show');
                    // Add a small delay for fade out animation before hiding
                    setTimeout(() => {
                        notificationBar.classList.add('hidden'); 
                    }, 300);
                }, duration);
            }

            // --- LANGUAGE FUNCTIONS ---
            /**
             * Sets the current language and updates all UI elements with data-i18n attributes.
             * @param {string} lang - 'en' for English, 'th' for Thai.
             */
            function setLanguage(lang) {
                currentLang = lang;
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
                 document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    if (translations[lang][key]) {
                        el.placeholder = translations[lang][key];
                    }
                });
                
                // Apply/remove Thai font class to body
                if (lang === 'th') {
                    document.body.classList.add('thai-lang');
                } else {
                    document.body.classList.remove('thai-lang');
                }
                
                // Update active language button styling
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`lang-${lang}`).classList.add('active');
                
                // Re-render components affected by language (charts, tables, MQTT status)
                // Note: historical charts are now rendered only when their tab is active.
                renderCharts(); // Dashboard charts
                renderConfigTable();
                renderTables(); // Live data tables
                updateMqttStatusDisplay();
                updateUIBasedOnRole(); // Ensure role-based visibility is updated
                renderUserManagement(); // Re-render user list for language
                updateWelcomeMessage(); // Update welcome message for language
            }
            
            // --- REAL-TIME CLOCK & STATS ---
            /**
             * Updates the current time displayed in the header.
             */
            function updateClock() {
                const now = new Date();
                const thaiTime = new Date(now.getTime() + (7 * 60 * 60 * 1000)); // GMT+7
                
                const hours = thaiTime.getUTCHours().toString().padStart(2, '0');
                const minutes = thaiTime.getUTCMinutes().toString().padStart(2, '0');
                const seconds = thaiTime.getUTCSeconds().toString().padStart(2, '0');
                
                currentTimeEl.textContent = `${hours}:${minutes}:${seconds} +07:00`;
            }

            /**
             * Updates the display for MQTT connection status.
             */
            function updateMqttStatusDisplay() {
                if (!socket) {
                    mqttStatusText.textContent = translations[currentLang].disconnected;
                    mqttStatusText.className = 'font-bold text-red-600';
                    mqttStatusIndicator.className = 'connection-indicator disconnected';
                    return;
                }
                switch (socket.readyState) {
                    case WebSocket.CONNECTING:
                        mqttStatusText.textContent = translations[currentLang].connecting;
                        mqttStatusText.className = 'font-bold text-yellow-500';
                        mqttStatusIndicator.className = 'connection-indicator connecting';
                        break;
                    case WebSocket.OPEN:
                        mqttStatusText.textContent = translations[currentLang].connected;
                        mqttStatusText.className = 'font-bold text-green-600';
                        mqttStatusIndicator.className = 'connection-indicator connected';
                        break;
                    case WebSocket.CLOSING:
                    case WebSocket.CLOSED:
                        mqttStatusText.textContent = translations[currentLang].disconnected;
                        mqttStatusText.className = 'font-bold text-red-600';
                        mqttStatusIndicator.className = 'connection-indicator disconnected';
                        break;
                }
            }
            
            /**
             * Updates key performance indicators (KPIs) like device counts and message rate.
             */
            function updateStats() {
                // Device count and change
                const currentTotalDevices = Object.keys(liveData.gateways).length + Object.keys(liveData.dollies).length;
                const deviceChange = currentTotalDevices - prevTotalDevices;
                
                totalDevicesEl.textContent = currentTotalDevices;
                
                // Update device change arrow and text
                if (deviceChange > 0) {
                    deviceChangeEl.className = "text-sm font-normal text-green-600";
                    deviceChangeEl.innerHTML = `<i class="fas fa-arrow-up mr-1 animate-pulse"></i>${deviceChange}`;
                } else if (deviceChange < 0) {
                    deviceChangeEl.className = "text-sm font-normal text-red-600";
                    deviceChangeEl.innerHTML = `<i class="fas fa-arrow-down mr-1"></i>${Math.abs(deviceChange)}`;
                } else {
                    deviceChangeEl.className = "text-sm font-normal text-gray-600";
                    deviceChangeEl.innerHTML = `<i class="fas fa-minus mr-1"></i>0`;
                }
                prevTotalDevices = currentTotalDevices;

                // Messages per minute (data flow)
                // Animate text for message rate to indicate update
                messagesReceivedEl.style.transform = 'scale(1.1)';
                messagesReceivedEl.textContent = lastMinuteMessageCount;
                setTimeout(() => {
                    messagesReceivedEl.style.transform = 'scale(1)';
                }, 100); // Quick animation
                
                lastMinuteMessageCount = 0; // Reset for next minute
                
                // Uptime (simplified - always 100% for this demo)
                uptimeEl.textContent = "100";
            }

            // --- MQTT CONNECTION VIA WEBSOCKET PROXY ---
            /**
             * Establishes and manages the WebSocket connection to the MQTT proxy.
             */
            function connectToMQTT() {
                const WS_PROXY_URL = 'ws://localhost:9001'; 
                
                // Prevent multiple connections if already connecting or open
                if (socket && (socket.readyState === WebSocket.CONNECTING || socket.readyState === WebSocket.OPEN)) {
                    console.log("WebSocket already connecting or open. Skipping new connection attempt.");
                    return;
                }

                updateMqttStatusDisplay(); // Set to 'Connecting...'
                
                try {
                    socket = new WebSocket(WS_PROXY_URL);
                } catch (e) {
                    console.error("WebSocket connection initiation error:", e);
                    updateMqttStatusDisplay(); // Set to 'Disconnected'
                    showNotification(translations[currentLang].mqttError + `: Failed to create WebSocket. Is the proxy server running?`, 'error', 7000);
                    return;
                }

                socket.onopen = () => {
                    console.log('WebSocket connection to proxy established!');
                    updateMqttStatusDisplay(); // Set to 'Connected'
                    showNotification(translations[currentLang].mqttConnected, 'success');
                };

                socket.onmessage = (event) => {
                    messageCount++; // Increment total message count
                    lastMinuteMessageCount++; // Increment message count for messages/min KPI
                    try {
                        const data = JSON.parse(event.data);
                        
                        // Handle status/error messages from proxy
                        if (data.status) {
                            if (data.status === 'connected') {
                                updateMqttStatusDisplay();
                                showNotification(translations[currentLang].mqttConnected, 'success');
                            } else if (data.status === 'disconnected') {
                                mqttStatusText.innerHTML = `${translations[currentLang].disconnected} ${data.error ? `(${data.error})` : ''}`;
                                mqttStatusText.className = 'font-bold text-red-600';
                                mqttStatusIndicator.className = 'connection-indicator disconnected';
                                showNotification(translations[currentLang].mqttDisconnected + (data.error ? `: ${data.error}` : ''), 'error', 5000);
                            }
                            return; // This was a status message, not an MQTT message
                        }
                        
                        if (data.error) {
                            console.error('Error from proxy:', data.error);
                            // Only update status text if it's a critical connection error, not just a data error
                            if (data.error.includes("MQTT Broker Connection Error") || data.error.includes("MQTT Client Offline")) {
                                mqttStatusText.innerHTML = `Proxy Error: ${data.error}`;
                                mqttStatusText.className = 'font-bold text-red-600';
                                showNotification(translations[currentLang].mqttError + `: ${data.error}`, 'error', 5000);
                            } else {
                                // For other errors, just log and possibly show a subtle warning
                                console.warn(`Non-critical proxy error: ${data.error}`);
                            }
                            return;
                        }

                        // Process MQTT message
                        const { topic, payload } = data;
                        let actualPayload;
                        
                        try {
                            actualPayload = JSON.parse(payload);
                        } catch (parseError) {
                            console.warn(`Could not parse MQTT payload for topic ${topic}:`, payload, parseError);
                            actualPayload = { _raw_payload_string: payload }; // Store raw if parse fails
                        }
                        
                        // console.log(`Received MQTT message on topic ${topic}:`, actualPayload); // Uncomment for verbose logging
                        
                        let updatedElementId = null;

                        // Handle different MQTT topics
                        if (topic === 'heltec/lora/data' && typeof actualPayload === 'object') {
                            const { gateway_id, rssi, node_id } = actualPayload;
                            const timestamp = Date.now(); // Record current time for lastSeen

                            // Update or add gateway to liveData
                            if (gateway_id) {
                                // If a gateway is not in configured list, add it as a dynamic entry
                                if (!liveData.gateways[gateway_id]) {
                                    liveData.gateways[gateway_id] = { 
                                        id: gateway_id, 
                                        name: `${translations[currentLang].unknown} Gateway`, 
                                        status: 'UNKNOWN', 
                                        lastSeen: 0, 
                                        lat: null, 
                                        lon: null // No GPS for dynamic gateways by default
                                    };
                                }
                                liveData.gateways[gateway_id].status = 'ONLINE';
                                liveData.gateways[gateway_id].lastSeen = timestamp;
                                updatedElementId = `gw-row-${gateway_id}`;
                            }

                            // Update or add dolly to liveData
                            if (node_id) {
                                const currentDolly = liveData.dollies[node_id] || { id: node_id, status: 'OFFLINE' };
                                liveData.dollies[node_id] = {
                                    ...currentDolly, // Retain existing properties (like gatewayId if not new)
                                    gatewayId: gateway_id, // Link to the gateway it's currently reporting through
                                    rssi: rssi,
                                    distance: calculateDistance(rssi),
                                    status: 'ONLINE',
                                    lastSeen: timestamp
                                };
                                updatedElementId = `dolly-row-${node_id}`;
                            }
                        } 
                        else if (topic.startsWith('heltec/gateway/') && topic.endsWith('/status')) {
                            const gateway_id_from_topic = topic.split('/')[2];
                            const status = actualPayload.status || 'UNKNOWN'; // Use payload status or default
                            const timestamp = Date.now();
                            
                            if (gateway_id_from_topic) {
                                // If gateway is not in configured list, add a placeholder
                                if (!liveData.gateways[gateway_id_from_topic]) {
                                    liveData.gateways[gateway_id_from_topic] = { 
                                        id: gateway_id_from_topic, 
                                        name: `${translations[currentLang].unknown} Gateway`, 
                                        status: 'UNKNOWN', 
                                        lastSeen: 0, 
                                        lat: null, 
                                        lon: null 
                                    };
                                }
                                liveData.gateways[gateway_id_from_topic].status = status.toUpperCase();
                                liveData.gateways[gateway_id_from_topic].lastSeen = timestamp;
                                updatedElementId = `gw-row-${gateway_id_from_topic}`;
                            }
                        } 
                        else if (topic.startsWith('heltec/nodes/') && topic.endsWith('/status')) {
                            const node_id_from_topic = topic.split('/')[2];
                            const status = actualPayload.status || 'UNKNOWN';
                            const gateway_id = actualPayload.gateway_id || null; // Can be in status message too
                            const timestamp = Date.now();
                            
                            if (node_id_from_topic) {
                                const currentDolly = liveData.dollies[node_id_from_topic] || { id: node_id_from_topic, status: 'OFFLINE' };
                                liveData.dollies[node_id_from_topic] = {
                                    ...currentDolly,
                                    status: status.toUpperCase(),
                                    gatewayId: gateway_id || currentDolly.gatewayId, // Update gateway if provided
                                    lastSeen: timestamp
                                };
                                updatedElementId = `dolly-row-${node_id_from_topic}`;
                            }
                        }

                        // Update UI if we have valid message data processed
                        renderAll();
                        
                        // Highlight updated row if available
                        if (updatedElementId) {
                            const rowElement = document.getElementById(updatedElementId);
                            if (rowElement) {
                                rowElement.classList.remove('highlight');
                                // Trigger reflow to restart animation
                                void rowElement.offsetWidth; 
                                rowElement.classList.add('highlight');
                            }
                        }

                    } catch (e) {
                        console.error("Error processing WebSocket message:", e);
                    }
                };

                socket.onclose = (event) => {
                    console.log('WebSocket connection closed:', event);
                    updateMqttStatusDisplay(); // Set to 'Disconnected'
                    // Mark all live devices as offline if proxy disconnects
                    Object.values(liveData.gateways).forEach(gw => gw.status = 'OFFLINE');
                    Object.values(liveData.dollies).forEach(dolly => dolly.status = 'OFFLINE');
                    renderAll();
                    showNotification(translations[currentLang].mqttDisconnected + `. Attempting to reconnect...`, 'error', 5000);
                    
                    // Attempt to reconnect after a delay
                    setTimeout(connectToMQTT, 3000);
                };

                socket.onerror = (error) => {
                    const errorMessage = `WebSocket connection error: Could not connect to the proxy server. Please ensure that 'proxy.js' is running in your terminal and is accessible at ws://localhost:9001.`;
                    console.error('[WebSocket ERROR] ', errorMessage, error); // Log the specific message and the error object
                    showNotification(translations[currentLang].mqttError + `: ${errorMessage}`, 'error', 7000);
                    updateMqttStatusDisplay(); // Set to 'Disconnected'
                };
            }

            /**
             * Disconnects the WebSocket connection gracefully.
             */
            function disconnectFromMQTT() {
                if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
                    socket.close();
                    console.log("WebSocket connection gracefully closed.");
                }
                socket = null; // Clear the socket instance
                updateMqttStatusDisplay(); // Update status display immediately
            }
            
            // --- HELPER FUNCTIONS ---
            /**
             * Calculates an estimated distance from RSSI.
             * This is a simple model and may require calibration for real-world accuracy.
             * @param {number} rssi - The Received Signal Strength Indicator in dBm.
             * @returns {string} Estimated distance in meters or 'N/A'.
             */
            function calculateDistance(rssi) {
                if (rssi === undefined || rssi === null || isNaN(rssi) || rssi >= 0) return translations[currentLang].unknown;
                // Typical values for LoRa:
                const txPower = -59; // Power at 1 meter in dBm (calibration value)
                const n = 2.5; // Path loss exponent (2.0 for free space, 2.5-3.5 for indoor/cluttered environments)
                
                // Distance formula: d = 10^((TxPower - RSSI) / (10 * n))
                const distance = Math.pow(10, (txPower - rssi) / (10 * n));
                return distance.toFixed(2);
            }

            /**
             * Formats a timestamp into a human-readable relative time string, falling back to absolute time.
             * @param {number} timestamp - Unix timestamp in milliseconds.
             * @returns {string} Formatted time string (e.g., "5 mins ago", "Yesterday", "2024-06-25 10:30 AM").
             */
            function formatTimestamp(timestamp) {
                if (!timestamp || timestamp === 0) return translations[currentLang].unknown;

                const now = Date.now();
                const diffSeconds = Math.floor((now - timestamp) / 1000);
                const diffMinutes = Math.floor(diffSeconds / 60);
                const diffHours = Math.floor(diffMinutes / 60);
                const diffDays = Math.floor(diffHours / 24);

                const date = new Date(timestamp);
                const locale = currentLang === 'th' ? 'th-TH' : 'en-US';

                if (diffSeconds < 60) {
                    return translations[currentLang].justNow;
                } else if (diffMinutes < 60) {
                    return `${diffMinutes} ${translations[currentLang].minutesAgo}`;
                } else if (diffHours < 24) {
                    return `${diffHours} ${translations[currentLang].hoursAgo}`;
                } else if (diffDays === 1) {
                    return translations[currentLang].yesterday;
                } else if (diffDays < 7) {
                    return `${diffDays} ${translations[currentLang].daysAgo}`;
                } else {
                    // Fallback to absolute date and time for older entries
                    return date.toLocaleDateString(locale, { year: 'numeric', month: 'short', day: 'numeric' }) + ' ' +
                           date.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
                }
            }

            /**
             * Initializes the Leaflet map instance.
             * This function is now called only once, the first time the map tab is activated.
             */
            function initializeMap() {
                if (mapInitialized) return; // Ensure it only runs once

                const defaultCenter = [13.736717, 100.523186]; // Bangkok, Thailand coordinates
                const defaultZoom = 12;

                map = L.map('map').setView(defaultCenter, defaultZoom);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                // Attach event listener for reset map button
                resetMapBtn.addEventListener('click', () => {
                    const locationsForFitBounds = []; // Collect all valid locations for map fitting
                    Object.values(configuredGateways).forEach(gw => {
                        if (gw.lat !== null && gw.lon !== null && !isNaN(gw.lat) && !isNaN(gw.lon)) {
                            locationsForFitBounds.push([gw.lat, gw.lon]);
                        }
                    });
                    // When resetting, consider all dollies based on their *current gateway location*
                    Object.values(liveData.dollies).forEach(dolly => {
                        const gateway = configuredGateways[dolly.gatewayId];
                        if (gateway && gateway.lat !== null && gateway.lon !== null && !isNaN(gateway.lat) && !isNaN(gateway.lon)) {
                            locationsForFitBounds.push([gateway.lat, gateway.lon]);
                        }
                    });

                    if (locationsForFitBounds.length > 0) {
                        map.fitBounds(locationsForFitBounds, { padding: [40, 40] });
                    } else {
                        map.setView(defaultCenter, defaultZoom);
                    }
                });
                
                mapInitialized = true;
                renderMap(); // Initial render of markers after map is set up
            }
            
            // --- RENDER FUNCTIONS ---
            /**
             * Renders all dashboard components.
             */
            function renderAll() {
                renderKPIs();
                renderCharts(); // Dashboard charts (always visible, safe to render on load)
                renderTables();
                renderConfigTable();
                // renderHistoricalCharts() and renderUserManagement() are now called by handleTabSwitch when their tabs are activated.
                
                // renderMap() is called conditionally by handleTabSwitch or initializeMap, or after data update
                if (document.getElementById('live-data').classList.contains('active') && mapInitialized) {
                    renderMap(); // Re-render map to reflect any new data/positions
                }
            }

            /**
             * Updates the KPI cards with current data.
             */
            function renderKPIs() {
                const totalGateways = Object.keys(configuredGateways).length;
                const onlineGateways = Object.values(liveData.gateways).filter(gw => gw.status === 'ONLINE').length;
                const totalDollies = Object.keys(liveData.dollies).length;
                const onlineDollies = Object.values(liveData.dollies).filter(d => d.status === 'ONLINE').length;

                document.getElementById('total-gateways').textContent = totalGateways;
                document.getElementById('online-gateways').textContent = onlineGateways;
                document.getElementById('total-dollies').textContent = totalDollies;
                document.getElementById('online-dollies').textContent = onlineDollies;
            }

            /**
             * Renders or updates the Chart.js instances for gateway and dolly status.
             */
            function renderCharts() {
                // Data for Gateways Chart: based on liveData
                let onlineGatewaysCount = 0;
                let offlineGatewaysCount = 0;
                let unknownGatewaysCount = 0;

                // First, categorize all *configured* gateways based on their live status
                Object.values(configuredGateways).forEach(configGw => {
                    const liveGw = liveData.gateways[configGw.id];
                    if (liveGw && liveGw.status === 'ONLINE') {
                        onlineGatewaysCount++;
                    } else if (liveGw && liveGw.status === 'OFFLINE') {
                        offlineGatewaysCount++;
                    } else { // If not in liveData or status is UNKNOWN (e.g., initially or after proxy disconnect)
                        unknownGatewaysCount++;
                    }
                });
                
                // Then, account for any "dynamic" gateways (those reporting via MQTT but not explicitly configured)
                // These will be considered 'UNKNOWN' status if they aren't explicitly configured.
                Object.values(liveData.gateways).forEach(liveGw => {
                    if (!configuredGateways[liveGw.id] && liveGw.status === 'ONLINE') {
                        // If an unconfigured gateway is online, it's still 'active' but we don't have its fixed location.
                        // For the chart, we might consider them 'online but unknown' if we had a separate category.
                        // For simplicity in a binary chart, they're part of the 'online' count.
                        // For now, these are implicitly covered in `onlineGatewaysCount` if their status from MQTT is 'ONLINE'.
                    }
                });

                const gatewayData = {
                    online: onlineGatewaysCount,
                    // Group offline and unknown configured gateways for the chart
                    offline: offlineGatewaysCount + unknownGatewaysCount 
                };

                // Data for Dollies Chart: based on liveData
                const dollyData = {
                    online: Object.values(liveData.dollies).filter(d => d.status === 'ONLINE').length,
                    offline: Object.values(liveData.dollies).filter(d => d.status !== 'ONLINE').length,
                };

                const chartConfig = (data, chartLabel) => ({
                    type: 'doughnut',
                    data: {
                        labels: [translations[currentLang].online, translations[currentLang].offline],
                        datasets: [{
                            label: chartLabel,
                            data: [data.online, data.offline],
                            backgroundColor: ['#10b981', '#ef4444'], // Success green, Danger red
                            borderColor: '#ffffff',
                            borderWidth: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        family: currentLang === 'th' ? "'Noto Sans Thai', sans-serif" : "'Inter', sans-serif",
                                        size: 14
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        cutout: '60%'
                    }
                });

                // Destroy existing charts before re-creating to prevent memory leaks and ensure updates
                if (gatewaysChartInstance) gatewaysChartInstance.destroy();
                gatewaysChartInstance = new Chart(document.getElementById('gatewaysChart').getContext('2d'), chartConfig(gatewayData, translations[currentLang].gateways));

                if (dolliesChartInstance) dolliesChartInstance.destroy();
                dolliesChartInstance = new Chart(document.getElementById('dolliesChart').getContext('2d'), chartConfig(dollyData, translations[currentLang].dollies));
            }

            /**
             * Renders or updates the live data tables for gateways and dollies.
             * Also applies search filtering.
             */
            function renderTables() {
                // Gateways Table
                gatewaysTbody.innerHTML = ''; // Clear current table content
                const liveGatewaysArray = Object.values(configuredGateways); // Use configured gateways to show all expected devices
                const gatewaySearchTerm = searchGatewaysInput.value.toLowerCase();

                const filteredGateways = liveGatewaysArray.filter(gw => 
                    gw.id.toLowerCase().includes(gatewaySearchTerm) ||
                    gw.name.toLowerCase().includes(gatewaySearchTerm)
                );

                if (filteredGateways.length === 0) {
                    gatewaysTbody.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-center text-gray-500">${translations[currentLang].noGatewaysLive}</td></tr>`;
                } else {
                    filteredGateways.forEach(configGw => {
                        const liveGw = liveData.gateways[configGw.id];
                        // Determine status based on liveData, default to 'OFFLINE' if no recent live data
                        const status = liveGw ? liveGw.status : 'OFFLINE';
                        const statusText = translations[currentLang][status.toLowerCase()] || translations[currentLang].unknown; // Fallback to 'unknown' if status is unrecognized

                        const statusClass = status === 'ONLINE' ? 'text-green-600' : (status === 'OFFLINE' ? 'text-red-600' : 'text-gray-600');
                        const statusIcon = status === 'ONLINE'
                            ? '<span class="pulse-online mr-2"></span>'
                            : `<i class="fas fa-circle ${status === 'OFFLINE' ? 'text-red-500' : 'text-gray-500'} mr-2"></i>`;
                        
                        const lastSeenTime = liveGw && liveGw.lastSeen ? formatTimestamp(liveGw.lastSeen) : translations[currentLang].unknown;

                        const row = `
                            <tr id="gw-row-${configGw.id}" class="hover:bg-indigo-50 transition duration-150 ease-in-out">
                                <td class="px-4 py-3 font-medium">${configGw.id}</td>
                                <td class="px-4 py-3 font-bold ${statusClass}">${statusIcon}${statusText}</td>
                                <td class="px-4 py-3 text-gray-600">${lastSeenTime}</td>
                            </tr>
                        `;
                        gatewaysTbody.insertAdjacentHTML('beforeend', row);
                    });
                }


                // Dollies Table
                dolliesTbody.innerHTML = ''; // Clear current table content
                const liveDolliesArray = Object.values(liveData.dollies);
                const dollySearchTerm = searchDolliesInput.value.toLowerCase();

                const filteredDollies = liveDolliesArray.filter(dolly => 
                    dolly.id.toLowerCase().includes(dollySearchTerm) ||
                    (dolly.gatewayId && dolly.gatewayId.toLowerCase().includes(dollySearchTerm))
                );

                if (filteredDollies.length === 0) {
                    dolliesTbody.innerHTML = `<tr><td colspan="6" class="px-4 py-3 text-center text-gray-500">${translations[currentLang].noDolliesLive}</td></tr>`;
                } else {
                    filteredDollies.forEach(dolly => {
                        const statusText = translations[currentLang][dolly.status.toLowerCase()] || translations[currentLang].unknown;
                        const statusClass = dolly.status === 'ONLINE' ? 'text-green-600' : 'text-red-600';
                        const statusIcon = dolly.status === 'ONLINE' ? '<span class="pulse-online mr-2"></span>' : '<i class="fas fa-circle text-red-500 mr-2"></i>';
                        
                        const lastSeenTime = dolly.lastSeen ? formatTimestamp(dolly.lastSeen) : translations[currentLang].unknown;

                        const row = `
                            <tr id="dolly-row-${dolly.id}" class="hover:bg-indigo-50 transition duration-150 ease-in-out">
                                <td class="px-4 py-3 font-medium">${dolly.id}</td>
                                <td class="px-4 py-3 font-bold ${statusClass}">${statusIcon}${statusText}</td>
                                <td class="px-4 py-3 text-gray-600">${dolly.gatewayId || translations[currentLang].unknown}</td>
                                <td class="px-4 py-3 text-gray-600">${dolly.rssi !== undefined ? dolly.rssi : translations[currentLang].unknown}</td>
                                <td class="px-4 py-3 text-gray-600">${dolly.distance !== undefined ? dolly.distance : translations[currentLang].unknown}</td>
                                <td class="px-4 py-3 text-gray-600">${lastSeenTime}</td>
                            </tr>
                        `;
                        dolliesTbody.insertAdjacentHTML('beforeend', row);
                    });
                }
            }

            /**
             * Renders or updates the configuration table for gateways.
             */
            function renderConfigTable() {
                configGatewaysTbody.innerHTML = ''; // Clear current table content
                const configuredGatewaysArray = Object.values(configuredGateways);

                // Only render the configuration table if the user is an admin
                if (currentUser && currentUser.role === 'admin') {
                    document.getElementById('gateway-form').classList.remove('hidden');
                    document.getElementById('config-gateways-tbody').closest('.card').classList.remove('hidden'); // Show table container
                    if (configuredGatewaysArray.length === 0) {
                        configGatewaysTbody.innerHTML = `<tr><td colspan="3" class="px-4 py-3 text-center text-gray-500">${translations[currentLang].noGatewaysConfigured}</td></tr>`;
                    } else {
                        configuredGatewaysArray.forEach(gw => {
                            const row = `
                                <tr class="hover:bg-indigo-50 transition duration-150 ease-in-out">
                                    <td class="px-4 py-3 font-medium">${gw.id}</td>
                                    <td class="px-4 py-3 text-gray-600">${gw.name}</td>
                                    <td class="px-4 py-3 space-x-2">
                                        <button class="edit-btn text-indigo-600 hover:text-indigo-900 transition duration-150" data-id="${gw.id}">
                                            <i class="fas fa-edit mr-1"></i><span data-i18n="edit">${translations[currentLang].edit}</span>
                                        </button>
                                        <button class="delete-btn text-red-600 hover:text-red-900 transition duration-150" data-id="${gw.id}">
                                            <i class="fas fa-trash-alt mr-1"></i><span data-i18n="delete">${translations[currentLang].delete}</span>
                                        </button>
                                    </td>
                                </tr>
                            `;
                            configGatewaysTbody.insertAdjacentHTML('beforeend', row);
                        });
                    }
                    // Re-attach event listeners after re-rendering to ensure they work on new elements
                    document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
                    document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
                } else {
                    document.getElementById('gateway-form').classList.add('hidden');
                    document.getElementById('config-gateways-tbody').closest('.card').classList.add('hidden'); // Hide table container
                }
            }
            
            /**
             * Creates a custom Leaflet DivIcon for dollies.
             * @param {string} status - The status of the dolly ('ONLINE', 'OFFLINE', 'UNKNOWN').
             * @param {string} id - The ID of the dolly (last two digits displayed).
             * @returns {L.DivIcon} A Leaflet DivIcon instance.
             */
            function createDollyIcon(status, id = '') {
                let statusClass = 'unknown';
                if (status === 'ONLINE') statusClass = 'online';
                else if (status === 'OFFLINE') statusClass = 'offline';
                
                // Use the last two digits for ID on marker for better uniqueness if IDs are long
                const displayId = id.length > 2 ? id.substring(id.length - 2) : id;

                return L.divIcon({
                    className: 'custom-dolly-icon',
                    html: `<div class="dolly-icon ${statusClass}">${displayId}</div>`,
                    iconSize: [28, 28], // Slightly larger
                    iconAnchor: [14, 14] // Center the icon
                });
            }
            
            /**
             * Renders or updates the Leaflet map with gateway and dolly markers.
             */
            function renderMap() {
                // Only render map if it has been initialized
                if (!mapInitialized) return;

                // Clear existing markers first
                for (const key in gatewayMapMarkers) {
                    if (gatewayMapMarkers[key]) map.removeLayer(gatewayMapMarkers[key]);
                    delete gatewayMapMarkers[key];
                }
                for (const key in dollyMapMarkers) {
                    if (dollyMapMarkers[key]) map.removeLayer(dollyMapMarkers[key]);
                    delete dollyMapMarkers[key];
                }

                const locationsForFitBounds = []; // Collect all valid locations for map fitting
                // Add configured gateway locations to fit bounds
                Object.values(configuredGateways).forEach(gw => {
                    if (gw.lat !== null && gw.lon !== null && !isNaN(gw.lat) && !isNaN(gw.lon)) {
                        locationsForFitBounds.push([gw.lat, gw.lon]);
                    }
                });
                
                // Group dollies by gateway ID to handle overlaps
                const dolliesByGateway = {};
                Object.values(liveData.dollies).forEach(dolly => {
                    if (dolly.gatewayId) {
                        if (!dolliesByGateway[dolly.gatewayId]) {
                            dolliesByGateway[dolly.gatewayId] = [];
                        }
                        dolliesByGateway[dolly.gatewayId].push(dolly);
                    }
                });


                const defaultCenter = [13.736717, 100.523186]; // Bangkok, Thailand coordinates
                const defaultZoom = 12;

                // Fit bounds or set view initially and on updates
                if (locationsForFitBounds.length > 0 || Object.keys(dolliesByGateway).length > 0) {
                    // Include all gateway locations and effective dolly locations for bounding
                    const allLocations = [...locationsForFitBounds];
                    Object.keys(dolliesByGateway).forEach(gwId => {
                        const gateway = configuredGateways[gwId];
                        if (gateway && gateway.lat !== null && gateway.lon !== null && !isNaN(gateway.lat) && !isNaN(gateway.lon)) {
                            allLocations.push([gateway.lat, gateway.lon]);
                        }
                    });
                    if (allLocations.length > 0) {
                        map.fitBounds(allLocations, { padding: [40, 40] });
                    } else {
                        map.setView(defaultCenter, defaultZoom);
                    }
                } else {
                    map.setView(defaultCenter, defaultZoom);
                }

                // Render Gateway Markers
                Object.values(configuredGateways).forEach(gw => {
                    if (gw.lat === null || gw.lon === null || isNaN(gw.lat) || isNaN(gw.lon)) {
                        console.warn(`Gateway ${gw.id} has no valid coordinates configured, skipping map marker.`);
                        return;
                    }
                    const liveGw = liveData.gateways[gw.id];
                    const status = liveGw ? liveGw.status : 'OFFLINE'; // Default to offline if no live data
                    const statusText = translations[currentLang][status.toLowerCase()] || translations[currentLang].unknown;
                    const lastSeenTime = liveGw && liveGw.lastSeen ? formatTimestamp(liveGw.lastSeen) : translations[currentLang].unknown;
                    
                    const popupContent = `
                        <b>${gw.name} (${gw.id})</b><br>
                        ${translations[currentLang].status}: ${statusText}<br>
                        ${translations[currentLang].lastSeen}: ${lastSeenTime}
                    `;
                    // Use different colored markers based on status
                    const iconColor = status === 'ONLINE' ? 'green' : (status === 'OFFLINE' ? 'red' : 'grey'); // Grey for unknown
                    const markerIcon = L.icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${iconColor}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });

                    const marker = L.marker([gw.lat, gw.lon], { icon: markerIcon }).addTo(map)
                        .bindPopup(popupContent);
                    gatewayMapMarkers[gw.id] = marker;
                });

                // Render Dolly Markers with radial offset
                Object.keys(dolliesByGateway).forEach(gwId => {
                    const gateway = configuredGateways[gwId];
                    const dolliesAtGateway = dolliesByGateway[gwId];

                    if (!gateway || gateway.lat === null || gateway.lon === null || isNaN(gateway.lat) || isNaN(gateway.lon)) {
                        console.warn(`Gateway ${gwId} for dollies has no valid coordinates configured, skipping map markers for these dollies.`);
                        return;
                    }

                    const baseLat = gateway.lat;
                    const baseLon = gateway.lon;
                    const offsetRadius = 0.0003; // Small radius in degrees for offset
                    const angleStep = (2 * Math.PI) / dolliesAtGateway.length; // Angle between each dolly

                    dolliesAtGateway.forEach((dolly, index) => {
                        // Calculate offset coordinates for each dolly
                        const angle = index * angleStep;
                        const offsetX = offsetRadius * Math.cos(angle);
                        const offsetY = offsetRadius * Math.sin(angle);

                        // Leaflet uses [latitude, longitude]
                        const dollyLat = baseLat + offsetY; // Latitudinal offset
                        const dollyLon = baseLon + offsetX; // Longitudinal offset

                        const statusText = translations[currentLang][dolly.status.toLowerCase()] || translations[currentLang].unknown;
                        const lastSeenTime = dolly.lastSeen ? formatTimestamp(dolly.lastSeen) : translations[currentLang].unknown;
                        const popupContent = `
                            <b>${translations[currentLang].id}: ${dolly.id}</b><br>
                            ${translations[currentLang].status}: ${statusText}<br>
                            ${translations[currentLang].gateway}: ${dolly.gatewayId || translations[currentLang].unknown}<br>
                            ${translations[currentLang].rssi}: ${dolly.rssi !== undefined ? dolly.rssi : translations[currentLang].unknown} dBm<br>
                            ${translations[currentLang].distance}: ${dolly.distance || translations[currentLang].unknown}<br>
                            ${translations[currentLang].lastSeen}: ${lastSeenTime}
                        `;
                        const dollyIcon = createDollyIcon(dolly.status, dolly.id);

                        const marker = L.marker([dollyLat, dollyLon], { icon: dollyIcon }).addTo(map)
                            .bindPopup(popupContent);
                        dollyMapMarkers[dolly.id] = marker;
                    });
                });

                map.invalidateSize(); // Crucial for map rendering when tab is hidden initially
            }

            /**
             * Renders historical data charts.
             * This uses mock data as a full backend/database is not implemented in this frontend-only solution.
             */
            function renderHistoricalCharts() {
                // Ensure canvas elements exist before trying to create charts
                const hourlyCanvas = document.getElementById('hourlyMessageRateChart');
                const gatewayOnlineCanvas = document.getElementById('gatewayOnlinePercentageChart');
                const dollyOnlineCanvas = document.getElementById('dollyOnlinePercentageChart');

                if (!hourlyCanvas || !gatewayOnlineCanvas || !dollyOnlineCanvas) {
                    console.warn("One or more historical chart canvas elements not found. Skipping chart rendering.");
                    return;
                }

                // Get CSS variables
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary');
                const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success');

                // Mock data for Hourly Message Rate (past 24 hours)
                const hourlyLabels = Array.from({length: 24}, (_, i) => {
                    const hour = (new Date().getHours() + i + 1) % 24;
                    return `${hour}:00`;
                });
                const hourlyData = Array.from({length: 24}, () => Math.floor(Math.random() * 50) + 10); // Random messages per hour

                const hourlyMessageRateChartConfig = {
                    type: 'line',
                    data: {
                        labels: hourlyLabels,
                        datasets: [{
                            label: translations[currentLang].hourlyMessageRate,
                            data: hourlyData,
                            borderColor: primaryColor, // Use fetched CSS variable
                            backgroundColor: 'rgba(79, 70, 229, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: translations[currentLang].hourlyMessageRate,
                                font: {
                                    family: currentLang === 'th' ? "'Noto Sans Thai', sans-serif" : "'Inter', sans-serif",
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Hour',
                                    font: {
                                        family: currentLang === 'th' ? "'Noto Sans Thai', sans-serif" : "'Inter', sans-serif"
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Messages',
                                    font: {
                                        family: currentLang === 'th' ? "'Noto Sans Thai', sans-serif" : "'Inter', sans-serif"
                                    }
                                }
                            }
                        }
                    }
                };

                // Mock data for Gateway Online Percentage (past 7 days)
                const dailyLabels = Array.from({length: 7}, (_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - (6 - i)); // Show last 7 days including today
                    return d.toLocaleDateString(currentLang === 'th' ? 'th-TH' : 'en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                });
                const dailyGatewayData = Array.from({length: 7}, () => Math.floor(Math.random() * 20) + 70); // Random percentage between 70-90%

                const gatewayOnlinePercentageChartConfig = {
                    type: 'bar',
                    data: {
                        labels: dailyLabels,
                        datasets: [{
                            label: translations[currentLang].gatewayOnlinePercentage,
                            data: dailyGatewayData,
                            backgroundColor: successColor, // Use fetched CSS variable
                            borderColor: successColor,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: translations[currentLang].gatewayOnlinePercentage,
                                font: {
                                    family: currentLang === 'th' ? "'Noto Sans Thai', sans-serif" : "'Inter', sans-serif",
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date',
                                    font: {
                                        family: currentLang === 'th' ? "'Noto Sans Thai', sans-serif" : "'Inter', sans-serif"
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Online (%)',
                                    font: {
                                        family: currentLang === 'th' ? "'Noto Sans Thai', sans-serif" : "'Inter', sans-serif"
                                    }
                                }
                            }
                        }
                    }
                };

                // New Mock data for Dolly Online Percentage (past 7 days)
                const dailyDollyData = Array.from({length: 7}, () => Math.floor(Math.random() * 30) + 65); // Random percentage between 65-95%

                const dollyOnlinePercentageChartConfig = {
                    type: 'line', // Line chart for trend
                    data: {
                        labels: dailyLabels, // Reuse daily labels
                        datasets: [{
                            label: translations[currentLang].dollyOnlinePercentage,
                            data: dailyDollyData,
                            borderColor: primaryColor, // Use primary color for dolly chart
                            backgroundColor: 'rgba(79, 70, 229, 0.2)', // Light primary color for fill
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: translations[currentLang].dollyOnlinePercentage,
                                font: {
                                    family: currentLang === 'th' ? "'Noto Sans Thai', sans-serif" : "'Inter', sans-serif",
                                    size: 16
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date',
                                    font: {
                                        family: currentLang === 'th' ? "'Noto Sans Thai', sans-serif" : "'Inter', sans-serif"
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Online (%)',
                                    font: {
                                        family: currentLang === 'th' ? "'Noto Sans Thai', sans-serif" : "'Inter', sans-serif"
                                    }
                                }
                            }
                        }
                    }
                };

                // Destroy existing charts before re-creating
                if (hourlyMessageRateChartInstance) hourlyMessageRateChartInstance.destroy();
                hourlyMessageRateChartInstance = new Chart(hourlyCanvas.getContext('2d'), hourlyMessageRateChartConfig);

                if (gatewayOnlinePercentageChartInstance) gatewayOnlinePercentageChartInstance.destroy();
                gatewayOnlinePercentageChartInstance = new Chart(gatewayOnlineCanvas.getContext('2d'), gatewayOnlinePercentageChartConfig);

                // Destroy and create the new Dolly Online Percentage Chart
                if (dollyOnlinePercentageChartInstance) dollyOnlinePercentageChartInstance.destroy();
                dollyOnlinePercentageChartInstance = new Chart(dollyOnlineCanvas.getContext('2d'), dollyOnlinePercentageChartConfig);
            }

            /**
             * Renders the mock user list in the User Management tab.
             * This function only runs if the current user is an admin.
             */
            function renderUserManagement() {
                userListTbody.innerHTML = ''; // Clear current table content

                if (currentUser && currentUser.role === 'admin') {
                    // Convert mockUsers object into an array for easier iteration
                    const usersArray = Object.keys(mockUsers).map(username => ({
                        username: username,
                        role: mockUsers[username].role
                    }));

                    if (usersArray.length === 0) {
                        userListTbody.innerHTML = `<tr><td colspan="2" class="px-4 py-3 text-center text-gray-500">No users found.</td></tr>`;
                    } else {
                        usersArray.forEach(user => {
                            const row = `
                                <tr class="hover:bg-indigo-50 transition duration-150 ease-in-out">
                                    <td class="px-4 py-3 font-medium">${user.username}</td>
                                    <td class="px-4 py-3 text-gray-600">${user.role}</td>
                                </tr>
                            `;
                            userListTbody.insertAdjacentHTML('beforeend', row);
                        });
                    }
                } else {
                    // If not an admin, clear the table and potentially show a message
                    userListTbody.innerHTML = `<tr><td colspan="2" class="px-4 py-3 text-center text-gray-500">Access Denied. Only administrators can view user management.</td></tr>`;
                }
            }

            /**
             * Calls the Gemini API to generate a network status summary.
             */
            async function generateNetworkSummary() {
                // Show loading state
                generateSummaryBtn.disabled = true;
                summaryButtonText.classList.add('hidden');
                summarySpinner.classList.remove('hidden');
                llmSummaryContent.innerHTML = '';
                llmSummaryLoading.classList.remove('hidden');
                llmSummaryModal.classList.add('show');

                const totalConfiguredGateways = Object.keys(configuredGateways).length;
                const onlineGateways = Object.values(liveData.gateways).filter(gw => gw.status === 'ONLINE').length;
                const offlineGateways = totalConfiguredGateways - onlineGateways; // Configured but not online
                const totalDollies = Object.keys(liveData.dollies).length;
                const onlineDollies = Object.values(liveData.dollies).filter(d => d.status === 'ONLINE').length;
                const offlineDollies = totalDollies - onlineDollies;
                const currentMessageRate = lastMinuteMessageCount; // messages per minute

                let onlineGatewaysList = Object.values(liveData.gateways).filter(gw => gw.status === 'ONLINE').map(gw => gw.id).join(', ') || 'None';
                let offlineGatewaysList = Object.values(liveData.gateways).filter(gw => gw.status === 'OFFLINE').map(gw => gw.id).join(', ') || 'None';
                let onlineDolliesList = Object.values(liveData.dollies).filter(dolly => dolly.status === 'ONLINE').map(dolly => dolly.id).join(', ') || 'None';
                let offlineDolliesList = Object.values(liveData.dollies).filter(dolly => dolly.status === 'OFFLINE').map(dolly => dolly.id).join(', ') || 'None';

                // Construct prompt
                const prompt = `Generate a concise and professional summary of the current dolly tracking network status.
                
                Network Statistics:
                - Total configured gateways: ${totalConfiguredGateways}
                - Online gateways: ${onlineGateways} (IDs: ${onlineGatewaysList})
                - Offline gateways: ${offlineGateways} (IDs: ${offlineGatewaysList})
                - Total dollies detected: ${totalDollies}
                - Online dollies: ${onlineDollies} (IDs: ${onlineDolliesList})
                - Offline dollies: ${offlineDollies} (IDs: ${offlineDolliesList})
                - Current message rate: ${currentMessageRate} messages per minute.
                
                Focus on overall network health, highlighting areas of strong performance and any potential concerns (e.g., significant number of offline devices). Keep it brief, factual, and actionable if issues are present.`;

                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // Leave this as-is; Canvas will automatically provide it.
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        llmSummaryContent.innerHTML = text; // Display LLM response
                    } else {
                        llmSummaryContent.textContent = "Error: Could not generate summary. No valid response from LLM.";
                        console.error("LLM response structure unexpected:", result);
                    }
                } catch (error) {
                    llmSummaryContent.textContent = `Error generating summary: ${error.message}. Please check your network connection and API setup.`;
                    console.error("Error calling Gemini API:", error);
                } finally {
                    // Hide loading state
                    generateSummaryBtn.disabled = false;
                    summaryButtonText.classList.remove('hidden');
                    summarySpinner.classList.add('hidden');
                    llmSummaryLoading.classList.add('hidden');
                }
            }


            // --- EVENT HANDLERS ---
            /**
             * Handles switching between main dashboard tabs.
             * @param {Event} e - The click event.
             */
            function handleTabSwitch(e) {
                document.querySelectorAll('.main-tab-button').forEach(button => {
                    button.classList.remove('active');
                });

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });

                e.target.classList.add('active');
                const targetTabId = e.target.dataset.tab;
                
                document.getElementById(targetTabId).classList.remove('hidden');

                // Invalidate map size after showing the map tab, with a short delay
                if (targetTabId === 'live-data') {
                    // Initialize map only the first time the tab is opened
                    if (!mapInitialized) {
                        initializeMap();
                    }
                    setTimeout(() => {
                        map.invalidateSize();
                        renderMap(); // Ensure markers are redrawn with new positions if data changed
                    }, 200);
                }
                // Re-render historical charts if switching to that tab
                if (targetTabId === 'historical-trends') {
                    renderHistoricalCharts();
                }
                // Re-render user management table if switching to that tab
                if (targetTabId === 'user-management') {
                    renderUserManagement();
                }
            }

            /**
             * Handles switching between sub-tabs within the live data section (Gateways vs. Dollies tables).
             * @param {Event} e - The click event.
             */
            function handleSubTabSwitch(e) {
                const showGatewaysBtn = document.getElementById('show-gateways-btn');
                const showDolliesBtn = document.getElementById('show-dollies-btn');
                const gatewaysTableContainer = document.getElementById('gateways-table-container');
                const dolliesTableContainer = document.getElementById('dollies-table-container');

                // Remove active classes from all sub-tab buttons
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active', 'bg-indigo-50', 'text-indigo-700');
                    btn.classList.add('hover:bg-indigo-50'); // Re-add hover effect
                });

                if (e.target.id === 'show-gateways-btn') {
                    gatewaysTableContainer.classList.remove('hidden');
                    dolliesTableContainer.classList.add('hidden');
                    showGatewaysBtn.classList.add('active', 'bg-indigo-50', 'text-indigo-700');
                    showGatewaysBtn.classList.remove('hover:bg-indigo-50');
                } else if (e.target.id === 'show-dollies-btn') {
                    gatewaysTableContainer.classList.add('hidden');
                    dolliesTableContainer.classList.remove('hidden');
                    showDolliesBtn.classList.add('active', 'bg-indigo-50', 'text-indigo-700');
                    showDolliesBtn.classList.remove('hover:bg-indigo-50');
                }
            }

            /**
             * Handles form submission for adding or editing a gateway.
             * @param {Event} e - The form submission event.
             */
            async function handleFormSubmit(e) {
                e.preventDefault();

                // Only allow admins to submit this form
                if (!currentUser || currentUser.role !== 'admin') {
                    await showAlert("Unauthorized: Only admin users can modify gateway configurations.", "Access Denied");
                    return;
                }

                const editId = document.getElementById('edit-id').value;
                const gatewayId = document.getElementById('gatewayId').value.trim();
                const gatewayName = document.getElementById('gatewayName').value.trim();
                const latitude = parseFloat(document.getElementById('latitude').value);
                const longitude = parseFloat(document.getElementById('longitude').value);

                if (!gatewayId || !gatewayName || isNaN(latitude) || isNaN(longitude)) {
                    await showAlert(translations[currentLang].alertFillAllFields);
                    return;
                }

                // If editing an existing gateway with a changed ID
                if (editId && editId !== gatewayId) {
                    // Confirm before deleting old entry
                    const confirmed = await showConfirm(`${translations[currentLang].alertDeleteConfirm} ${editId} to change its ID to ${gatewayId}?`);
                    if (!confirmed) {
                        return; // Stop if user cancels
                    }
                    delete configuredGateways[editId];
                    if (liveData.gateways[editId]) {
                        delete liveData.gateways[editId];
                    }
                }
                
                configuredGateways[gatewayId] = {
                    id: gatewayId,
                    name: gatewayName,
                    lat: latitude,
                    lon: longitude
                };

                // Update or create entry in liveData, preserving existing status/lastSeen if any
                liveData.gateways[gatewayId] = { 
                    ...liveData.gateways[gatewayId] || { status: 'UNKNOWN', lastSeen: 0 }, 
                    ...configuredGateways[gatewayId] 
                };

                renderAll();
                gatewayForm.reset();
                document.getElementById('edit-id').value = ''; // Clear edit ID
                showNotification(translations[currentLang].gatewaySaved, 'success');
            }

            /**
             * Clears the gateway form.
             */
            function handleClearForm() {
                gatewayForm.reset();
                document.getElementById('edit-id').value = '';
            }
            
            /**
             * Populates the form with data for editing a gateway.
             * @param {Event} e - The click event from the edit button.
             */
            async function handleEdit(e) {
                // Only allow admins to edit
                if (!currentUser || currentUser.role !== 'admin') {
                    await showAlert("Unauthorized: Only admin users can edit gateway configurations.", "Access Denied");
                    return;
                }
                const id = e.target.closest('button').dataset.id;
                const gateway = configuredGateways[id];
                if (gateway) {
                    document.getElementById('edit-id').value = id;
                    document.getElementById('gatewayId').value = gateway.id;
                    document.getElementById('gatewayName').value = gateway.name;
                    document.getElementById('latitude').value = gateway.lat;
                    document.getElementById('longitude').value = gateway.lon;
                }
            }

            /**
             * Handles deleting a gateway from configuration.
             * @param {Event} e - The click event from the delete button.
             */
            async function handleDelete(e) {
                 // Only allow admins to delete
                if (!currentUser || currentUser.role !== 'admin') {
                    await showAlert("Unauthorized: Only admin users can delete gateway configurations.", "Access Denied");
                    return;
                }

                 const id = e.target.closest('button').dataset.id;
                 const confirmed = await showConfirm(`${translations[currentLang].alertDeleteConfirm} ${id}?`);
                 if (confirmed) {
                    delete configuredGateways[id];
                    // Also remove from liveData
                    if (liveData.gateways[id]) {
                        delete liveData.gateways[id];
                    }
                    renderAll();
                    showNotification(translations[currentLang].gatewayDeleted, 'success');
                 }
            }

            // --- SEARCH FILTERING ---
            function setupSearchFilters() {
                searchGatewaysInput.addEventListener('input', renderTables);
                searchDolliesInput.addEventListener('input', renderTables);
            }

            // --- PASSWORD VISIBILITY TOGGLE ---
            function setupPasswordToggle() {
                togglePassword.addEventListener('click', () => {
                    const passwordInput = document.getElementById('login-password');
                    const icon = togglePassword.querySelector('i');
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        passwordInput.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            }
            
            // --- INITIALIZATION ---
            /**
             * Initializes the dashboard by setting up language, event listeners, and initial renders.
             */
            function init() {
                // Set initial language
                setLanguage(currentLang);
                updateWelcomeMessage(); // Initial welcome message display

                // Setup main tab event listeners
                document.querySelectorAll('.main-tab-button').forEach(button => {
                    button.addEventListener('click', handleTabSwitch);
                });
                
                // Setup sub-tab event listeners
                document.getElementById('show-gateways-btn').addEventListener('click', handleSubTabSwitch);
                document.getElementById('show-dollies-btn').addEventListener('click', handleSubTabSwitch);
                
                // Setup form and config table listeners
                gatewayForm.addEventListener('submit', handleFormSubmit);
                document.getElementById('clear-form-btn').addEventListener('click', handleClearForm);
                
                // Setup language toggle listeners
                document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
                document.getElementById('lang-th').addEventListener('click', () => setLanguage('th'));
                
                // Setup scroll to top button
                scrollTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                
                // Set up search filters
                setupSearchFilters();

                // Setup password visibility toggle
                setupPasswordToggle();

                // Login form and logout button listeners
                loginForm.addEventListener('submit', handleLogin);
                logoutBtn.addEventListener('click', handleLogout);

                // LLM summary button listener
                generateSummaryBtn.addEventListener('click', generateNetworkSummary);

                // Check for existing session
                const storedUser = sessionStorage.getItem('currentUser');
                if (storedUser) {
                    try {
                        currentUser = JSON.parse(storedUser);
                        showMainApp(); // Show main app if logged in
                    } catch (e) {
                        console.error("Error parsing stored user session:", e);
                        showLoginScreen(); // Fallback to login
                    }
                } else {
                    showLoginScreen(); // Show login screen if no session
                }
                
                // Start clock and stats update intervals
                setInterval(updateClock, 1000);
                messageRateInterval = setInterval(updateStats, 60000); // Update stats every minute
                updateClock(); // Initial call
                updateStats(); // Initial call

                // Initial render of all components, but historical charts are now deferred
                renderAll();
                
                // connectToMQTT() is now called within showMainApp() after successful login
            }

            init();
        });
    </script>
</body>
</html>
